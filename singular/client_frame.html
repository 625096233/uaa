<!DOCTYPE html>
<html>
<head>
  <script type="application/javascript">
    var userId = '~';

    window.addEventListener("message", receiveMessage, false);

    window.onload = function () {
      var fragment = window.location.hash;
      var claims;

      fragment && fragment.length > 0 && (claims = getClaims(fragment.substring(1)));
      claims = claims || getStoredIdentity();

      if (claims) {
        userId = claims.user_id;
        storeIdentity(claims);
        window.parent.Singular.properties.onIdentityChange(claims);
      } else {
        userId = '~';
        window.parent.Singular.properties.onIdentityChange(null);
      }

      check_session();
      setInterval(check_session, window.parent.Singular.properties.checkInterval);
    };

    function check_session() {
      var sessionFrame = window.parent.Singular.sessionFrame.contentWindow;
      var sessionState = window.parent.Singular.properties.clientId + ' ' + userId;
      sessionFrame.postMessage(sessionState, getOrigin(window.parent.Singular.properties.uaaLocation));
    }

    function receiveMessage(e) {
      var status = e.data;
      if (status === "changed") {
        clearStoredIdentity();
        var fragmentPosition = window.location.href.lastIndexOf('#');
        var here = fragmentPosition > 0 ? window.location.href.substring(0, fragmentPosition) : window.location.href;
        window.location = window.parent.Singular.properties.uaaLocation + "/oauth/authorize?response_type=token%20id_token&client_id=" + window.parent.Singular.properties.clientId + "&prompt=none&redirect_uri=" + encodeURIComponent(here);
      } else if (status === "unchanged") {
        /* do nothing */
      } else /* error */ {
        userId = '~';
        clearStoredIdentity();
        window.parent.Singular.properties.onIdentityChange(null);
      }
    }

    function getIdToken(fragment) {
      var params = fragment.split('&');
      for (var i in params) {
        if (params[i].startsWith('id_token=')) {
          return params[i].substring(9);
        }
      }
    }

    function getClaims(fragment) {
      var jwt = getIdToken(fragment);
      if (!jwt) {
        return null;
      }
      var base64Url = jwt.split('.')[1];
      var base64 = base64Url.replace('-', '+').replace('_', '/');
      return JSON.parse(window.atob(base64));
    }

    function getStoredIdentity() {
      if (!localStorage) {
        return null;
      }
      try {
        return JSON.parse(localStorage.getItem(window.parent.Singular.properties.storageKey));
      } catch (err) {
        clearStoredIdentity();
        return null;
      }
    }

    function clearStoredIdentity() {
      if (localStorage) {
        localStorage.removeItem(window.parent.Singular.properties.storageKey);
      }
    }

    function storeIdentity(claims) {
      if (localStorage) {
        localStorage.setItem(window.parent.Singular.properties.storageKey, JSON.stringify(claims));
      }
    }

    function getOrigin(url) {
      try {
        return origin = /^(\S+?:\/\/[a-z0-9-.]+(:[0-9]+)?)/ig.exec(url)[0] + '/';
      } catch (err) {
        return null;
      }
    }
  </script>
</head>
<body>

</body>
</html>
